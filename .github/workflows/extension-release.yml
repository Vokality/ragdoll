name: Extension Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-extension:
    name: Build Extension Tarball
    # Run for extension releases (character-v*, tasks-v*, pomodoro-v*, spotify-v*, etc.)
    # Excludes chat-v* and emote-v* which have their own workflows
    # Core extensions use "extension-{name}-v*" format, third-party use "{name}-v*" format
    if: |
      startsWith(github.event.release.tag_name, 'extension-character-v') ||
      startsWith(github.event.release.tag_name, 'extension-tasks-v') ||
      startsWith(github.event.release.tag_name, 'extension-pomodoro-v') ||
      startsWith(github.event.release.tag_name, 'spotify-v')
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ github.event.release.tag_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure main branch
        run: |
          git checkout main
          git pull --ff-only origin main

      - name: Determine extension info
        id: ext
        run: |
          TAG="${RELEASE_TAG}"
          
          # Handle two formats:
          # 1. Core extensions: "extension-{name}-v{version}" (e.g., "extension-character-v0.1.0")
          # 2. Third-party extensions: "{name}-v{version}" (e.g., "spotify-v0.1.0")
          
          if [[ "$TAG" == extension-*-v* ]]; then
            # Core extension format: extension-{name}-v{version}
            # Remove "extension-" prefix first
            STRIPPED="${TAG#extension-}"
            # Extract name (everything before -v)
            EXT_NAME="${STRIPPED%%-v*}"
            # Extract version (everything after -v)
            VERSION="${STRIPPED#*-v}"
          else
            # Third-party format: {name}-v{version}
            EXT_NAME="${TAG%%-v*}"
            VERSION="${TAG#*-v}"
          fi
          
          if [ -z "$EXT_NAME" ] || [ -z "$VERSION" ] || [ "$EXT_NAME" = "$TAG" ]; then
            echo "Invalid release tag format. Expected: extension-{name}-v{version} or {name}-v{version}" >&2
            exit 1
          fi
          
          PACKAGE_DIR="packages/ragdoll-extension-${EXT_NAME}"
          
          if [ ! -d "$PACKAGE_DIR" ]; then
            echo "Extension package not found: $PACKAGE_DIR" >&2
            exit 1
          fi
          
          echo "name=${EXT_NAME}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "package_dir=${PACKAGE_DIR}" >> "$GITHUB_OUTPUT"
          echo "tarball_name=ragdoll-extension-${EXT_NAME}-${VERSION}.tar.gz" >> "$GITHUB_OUTPUT"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install workspace dependencies
        run: bun install --frozen-lockfile

      - name: Bump extension version
        run: |
          cd ${{ steps.ext.outputs.package_dir }}
          bun -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${{ steps.ext.outputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

      - name: Build ragdoll-extensions dependency
        run: |
          cd packages/ragdoll-extensions
          bun run build

      - name: Build extension
        run: |
          cd ${{ steps.ext.outputs.package_dir }}
          bun run build

      - name: Prepare tarball contents
        run: |
          cd ${{ steps.ext.outputs.package_dir }}
          
          # Create staging directory
          STAGING_DIR=$(mktemp -d)
          
          # Copy extension files
          cp package.json "$STAGING_DIR/"
          cp -r dist "$STAGING_DIR/"
          
          # Copy ragdoll-extensions dependency
          mkdir -p "$STAGING_DIR/node_modules/@vokality"
          cp -r ../../packages/ragdoll-extensions "$STAGING_DIR/node_modules/@vokality/ragdoll-extensions"
          
          # Remove source files and dev artifacts from dependency
          rm -rf "$STAGING_DIR/node_modules/@vokality/ragdoll-extensions/src"
          rm -rf "$STAGING_DIR/node_modules/@vokality/ragdoll-extensions/node_modules"
          rm -f "$STAGING_DIR/node_modules/@vokality/ragdoll-extensions/tsconfig.json"
          
          # Create tarball
          tar -czvf "${{ steps.ext.outputs.tarball_name }}" -C "$STAGING_DIR" .
          
          # Cleanup
          rm -rf "$STAGING_DIR"
          
          # Verify tarball
          echo "=== Tarball contents ==="
          tar -tzvf "${{ steps.ext.outputs.tarball_name }}"

      - name: Commit version bump
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(${{ steps.ext.outputs.name }}): bump to ${{ steps.ext.outputs.version }}"
          branch: main
          file_pattern: ${{ steps.ext.outputs.package_dir }}/package.json

      - name: Upload tarball to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: ${{ steps.ext.outputs.package_dir }}/${{ steps.ext.outputs.tarball_name }}
          fail_on_unmatched_files: true
